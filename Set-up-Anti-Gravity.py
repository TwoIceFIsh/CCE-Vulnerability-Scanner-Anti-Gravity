import os
import shutil

from antigravity.uac_require import uac_require

SYS_PATH = os.environ['WINDIR'] + '\\system32'
SET_UP_DIR = os.path.expanduser('~') + '\\.Anti-Gravity'
SVC_PROG_PATH = os.path.expanduser('~') + '\\.Anti-Gravity\\Anti-Gravity-Agent.exe'
SVC_NAME = 'Anti-Gravity-Service'
STARTUP_PATH = f'{os.path.expanduser("~")}\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup'
# 1. 관리자 권한 실행
if uac_require():

    # 설치 폴더 생성
    if os.path.isdir(SET_UP_DIR) is False:
        os.mkdir(SET_UP_DIR)

    # 설치 폴더로 복사
    shutil.copytree('.\\install', SET_UP_DIR, dirs_exist_ok=True)

    # 작업 스케줄 등록
    os.system(f'SCHTASKS /Create /TN {SVC_NAME} /SC ONLOGON /TR {SVC_PROG_PATH} /RL HIGHEST')

    # 에이전트 실행
    os.system(f'{SVC_PROG_PATH}')
else:
    print('bad')
#
# if uac_require():
#
#     shutil.copytree('.\\dll', SYS_PATH, dirs_exist_ok=True)
#
#     if os.path.isdir(SET_UP_DIR) is False:
#         os.mkdir(SET_UP_DIR)
#
#     # 2. 기존 서비스 조회 및 삭제
#     try:
#         output = subprocess.check_output(f'sc query {SVC_NAME}')
#         os.system(f'sc delete {SVC_NAME}')
#     except:
#         print('error')
#
#     # 3. Anti-Gravity-Agent 서비스 등록
#     os.system(f'sc create {SVC_NAME} binPath={SVC_PROG_PATH} start=auto')
#     os.system(f'{SVC_PROG_PATH}')
#     os.system(f'sc start {SVC_NAME}')
# else:
#     print('bad')
